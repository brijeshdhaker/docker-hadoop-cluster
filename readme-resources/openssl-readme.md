
#
# Generate Cert using SSL
#
openssl the openssl library
req     to process csr
-new    to create new csr
-newkey (optional) creates a new rsa key with modulus 2048
-nodes  (optional) do not encrypt private key
-subj   sets the subject name for the csr - if not defined you'll be asked interactively
-addext (optional) here you can define subjectAltName. As you can see multiple IPs with the IP:ip_address, notation (comma-separated) additionally you could define a wildcard DNS with DNS:*.your.domain
-keyout (optional) save to different name than default: key.pem
-out    (optional) save to different name than default: req.pem

# ca.ext
```shell
[ default ]
basicConstraints = critical,CA:true     # recommended to be marked critical. required for a ca
keyUsage         = critical,keyCertSign # required to be marked critical. required for signing certs
```
# root_req.config
```shell
[ req ]
distinguished_name = req_distinguished_name
prompt             = no

[ req_distinguished_name ]
countryName = US
commonName  = Test Root CA
```
# root.config
```shell
[ ca ]
default_ca             = CA_default

[ CA_default]
dir                    = ./root_ca      # helper variable pointing to ca specific files
database               = $dir/index     # database of certs generated by the ca
new_certs_dir          = ./             # one dir up to make the demo easier
certificate            = ./root.pem     # one dir up to make the demo easier
serial                 = $dir/serial    # file with incrementing hex serial number for certs
private_key            = ./root.key

policy                 = policy_any
email_in_dn            = no             # recommended
unique_subject         = no             # recommended for easier certificate rollover
copy_extensions        = none           # don't honor the extensions in the csr
default_md             = sha256

[ policy_any ]
countryName            = optional
stateOrProvinceName    = optional
organizationName       = optional
organizationalUnitName = optional
commonName             = supplied
```

# intermediate_req.config
```shell
[ req ]
distinguished_name     = req_distinguished_name
prompt                 = no

[ req_distinguished_name ]
countryName            = US
commonName             = Test Intermediate CA
```

# intermediate.config
```shell
[ ca ]
default_ca      = CA_default

[ CA_default]
dir             = ./intermediate_ca   # helper variable pointing to ca specific files
database        = $dir/index          # database of certs generated by the ca
new_certs_dir   = ./                  # one dir up to make the demo easier
certificate     = ./intermediate.pem  # one dir up to make the demo easier
serial          = $dir/serial         # file with incrementing hex serial number for certs
private_key     = ./intermediate.key

policy          = policy_any
email_in_dn     = no                  # recommended
unique_subject  = no                  # recommended for easier certificate rollover
copy_extensions = none                # don't honor the extensions in the csr
default_md      = sha256

[ policy_any ]
countryName            = optional
stateOrProvinceName    = optional
organizationName       = optional
organizationalUnitName = optional
commonName             = supplied
```
# leaf_req.config
```shell
[ req ]
distinguished_name = req_distinguished_name
prompt             = no

[ req_distinguished_name ]
countryName = US
commonName  = Test Leaf
```
# leaf.config
```shell
[ req ]
distinguished_name = req_distinguished_name
prompt             = no

[ req_distinguished_name ]
countryName = US
commonName  = Test Leaf
```

```shell
# create the private key for the root CA
openssl genrsa 
    -out root.key                   # output file
    2048                            # bitcount

# create the csr for the root CA
openssl req 
    -new 
    -key root.key                   # private key associated with the csr
    -out root.csr                   # output file
    -config root_req.config         # contains config for generating the csr such as the distinguished name

# create the root CA cert
openssl ca 
    -in root.csr                    # csr file
    -out root.pem                   # output certificate file
    -config root.config             # CA configuration file
    -selfsign                       # create a self-signed certificate
    -extfile ca.ext                 # extensions that must be present for CAs that sign certificates
    -days 1095                      # 3 years

# create the private key for the intermediate CA
openssl genrsa 
    -out intermediate.key           # output file
    2048                            # bitcount

# create the csr for the intermediate CA
openssl req 
    -new 
    -key intermediate.key           # private key associated with the csr
    -out intermediate.csr           # output file
    -config intermediate_req.config # contains config for generating the csr such as the distinguished name

# create the intermediate CA cert
openssl ca 
    -in intermediate.csr            # csr file
    -out intermediate.pem           # output certificate file
    -config root.config             # CA configuration file (note: root is still issuing)
    -extfile ca.ext                 # extensions that must be present for CAs that sign certificates
    -days 730                       # 2 years

# create the private key for the leaf certificate
openssl genrsa 
    -out leaf.key                   # output file
    2048                            # bitcount

# create the csr for the leaf certificate
openssl req 
    -new 
    -key leaf.key                   # private key associated with the csr
    -out leaf.csr                   # output file
    -config leaf_req.config         # contains config for generating the csr such as the distinguished name

# create the leaf certificate (note: no ca.ext. this certificate is not a CA)
openssl ca 
    -in leaf.csr                    # csr file
    -out leaf.pem                   # output certificate file
    -config intermediate.config     # CA configuration file (note: intermediate is issuing)
    -days 365                       # 1 year

# verify the certificate chain
openssl verify 
    -x509_strict                    # strict adherence to rules
    -CAfile root.pem                # root certificate
    -untrusted intermediate.pem     # file with all intermediates
    leaf.pem                        # leaf certificate to verify             
```


# Generate the certification authority (CA) key and certificate (Root CA)
```shell

openssl req -new \
-x509 \
-days 7300 \
-keyout /apps/security/ssl/sandbox-root-ca.key \
-out /apps/security/ssl/sandbox-root-ca.crt \
-subj '/CN=Sandbox-Root-CA/OU=Sandbox/O=Sandbox/L=Pune/ST=MH/C=IN' \
-passin pass:sandbox \
-passout pass:sandbox

```

# creating a new key and certificate that is valid for 365 days, uses the rsa:2048 encryption,
openssl req \
-new \
-nodes \
-days 365 \
-newkey rsa:2048 \
-keyout /apps/security/ssl/server.key \
-out /apps/security/ssl/server.csr \
-config /apps/security/ssl/server.cnf


#
# Sign the host certificate with the certificate authority (CA)
#
openssl x509 -req \
-days 3650 \
-in /apps/security/ssl/server.csr \
-CA /apps/security/ssl/sandbox-root-ca.crt \
-CAkey /apps/security/ssl/sandbox-root-ca.key \
-CAcreateserial \
-out /apps/security/ssl/server.crt \
-extfile /apps/security/ssl/server.cnf \
-extensions v3_req


#
# Verify HTTPS 
#
```shell

openssl s_client -connect localhost:19093 -tls1_3 -showcerts

# Kafka Broker
openssl s_client -connect kafkabroker.sandbox.net:19093 -tls1_3 -showcerts

# Zookeeper
openssl s_client -connect zookeeper.sandbox.net:28080 -tls1_3 -showcerts \ 
      -CAfile /etc/zookeeper/secrets/sandbox_ca.crt \
      -cert /etc/zookeeper/secrets/clients.certificate.pem \ 
      -key /etc/zookeeper/secrets/clients.key

# Schema Registry
openssl s_client -connect schemaregistry.sandbox.net:8081 -tls1_3 -showcerts \
      -cert conf/kafka/secrets/clients.certificate.pem \
      -key conf/kafka/secrets/clients.key

```

```shell

openssl s_server \
  -key ./bd-k8s-module/istio/certs/set-02/httpbin.sandbox.net.key \
  -cert ./bd-k8s-module/istio/certs/set-02/httpbin.sandbox.net.crt \
  -accept 5443 \
  -state \
  -www \
  -CAfile ./bd-k8s-module/istio/certs/ca-chain.crt \
  -verify 2 \
  -debug \
  -security_debug_verbose \
  -tls1_2 \
  -msg

openssl s_client \
  -tls1_2 \
  -showcerts \
  -connect localhost:5443 \
  -cert ./bd-k8s-module/istio/certs/client.sandbox.net.crt \
  -key ./bd-k8s-module/istio/certs/client.sandbox.net.key


openssl s_client -connect google.com:443 2>/dev/null | openssl x509 -noout -dates
echo | openssl s_client -connect example.org:443 2>/dev/null | openssl x509 -noout -ext subjectAltName
    
# Hit https://localhost:5443 in browser  

```
<<comment
 # Schema Registry Test :
comment

:'
echo"This doesnt echo"
echo"Even this doesnt"
'
